<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medical Test Report</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .header {
        display: flex;
        justify-content: center;
      }
      .patient-info {
        display: flex;
        justify-content: space-between;
        margin-top: 25px;
      }
      .container,
      .btnContainer {
        width: 210mm;
        margin: 20px auto;
      }
      .pageA4 {
        width: 210mm;
        height: 297mm;
        padding: 0.74in;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .groupName {
        text-align: left;
        text-decoration: underline;
        font-weight: 700;
        font-size: 19px;
        padding-bottom: 20px;
      }
      .footerHeader {
        margin-top: 25px;
        font-weight: 700;
      }
      .groupBody {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border: 1px solid #ddd;
        text-align: left;
      }
      .tableRow {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .dataItem {
        width: 33%;
      }
      .groupHeader {
        background-color: #f2f2f2;
        font-weight: 700;
      }
      .btn {
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .logo {
        width: 100px;
      }
      .logo img {
        height: 100%;
        width: 100%;
        object-fit: contain;
      }
      .testGroup {
        padding: 25px 0;
      }
      .footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .pagesContainer {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .testsContainer {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
      }
      @media print {
        .pageA4 {
          height: 100vh !important;
          page-break-before: always;
        }
        body > *:not(.pagesContainer) {
          display: none !important;
        }
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.debug.js"></script>
  </head>
  <body>
    <div id="content" class="container">
      <!-- Laboratory Name and Logo -->
      <div class="header">
        <div class="logo">
          <img src="./medical-lab.png" alt="Laboratory Logo" />
        </div>
      </div>

      <!-- Patient Information -->
      <div class="patient-info">
        <p>Patient: <b> John Doe </b></p>
        <p>Visit Date: <b> January 1, 2024 </b></p>
        <p>Patient ID: <b> 123456 </b></p>
      </div>

      <div class="testsContainer">
        <div class="testGroup">
          <div class="groupName">Blood Tests</div>
          <div class="groupHeader tableRow data">
            <div class="dataItem">Test Name</div>
            <div class="dataItem">Result</div>
            <div class="dataItem">Reference Range</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Hemoglobin</div>
            <div class="dataItem">13.5 g/dL</div>
            <div class="dataItem">12.0 - 15.5 g/dL</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">White Blood Cell Count</div>
            <div class="dataItem">7.2 x10^3/µL</div>
            <div class="dataItem">4.0 - 11.0 x10^3/µL</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Platelet Count</div>
            <div class="dataItem">250 x10^3/µL</div>
            <div class="dataItem">150 - 450 x10^3/µL</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Platelet Count</div>
            <div class="dataItem">250 x10^3/µL</div>
            <div class="dataItem">150 - 450 x10^3/µL</div>
          </div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
        </div>

        <div class="testGroup">
          <div class="groupName">Urine Tests</div>
          <div class="groupHeader tableRow data">
            <div class="dataItem">Test Name</div>
            <div class="dataItem">Result</div>
            <div class="dataItem">Reference Range</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Urine Specific Gravity</div>
            <div class="dataItem">1.015</div>
            <div class="dataItem">1.005 - 1.030</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Urine pH</div>
            <div class="dataItem">6.0</div>
            <div class="dataItem">4.5 - 8.0</div>
          </div>
        </div>

        <div class="testGroup">
          <div class="groupName">Liver Function Tests</div>
          <div class="groupHeader tableRow data">
            <div class="dataItem">Test Name</div>
            <div class="dataItem">Result</div>
            <div class="dataItem">Reference Range</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Alanine Aminotransferase (ALT)</div>
            <div class="dataItem">25 U/L</div>
            <div class="dataItem">0 - 40 U/L</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Aspartate Aminotransferase (AST)</div>
            <div class="dataItem">30 U/L</div>
            <div class="dataItem">0 - 35 U/L</div>
          </div>
        </div>

        <div class="testGroup">
          <div class="groupName">CBC (Complete Blood Count)</div>
          <div class="groupHeader tableRow data">
            <div class="dataItem">Test Name</div>
            <div class="dataItem">Result</div>
            <div class="dataItem">Reference Range</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Hemoglobin</div>
            <div class="dataItem">13.5 g/dL</div>
            <div class="dataItem">12.0 - 15.5 g/dL</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">White Blood Cell Count</div>
            <div class="dataItem">7.2 x10^3/µL</div>
            <div class="dataItem">4.0 - 11.0 x10^3/µL</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Platelet Count</div>
            <div class="dataItem">250 x10^3/µL</div>
            <div class="dataItem">150 - 450 x10^3/µL</div>
          </div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
        </div>

        <div class="testGroup">
          <div class="groupName">Chemistry</div>
          <div class="groupHeader tableRow data">
            <div class="dataItem">Test Name</div>
            <div class="dataItem">Result</div>
            <div class="dataItem">Reference Range</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Blood Glucose</div>
            <div class="dataItem">110 mg/dL</div>
            <div class="dataItem">70 - 100 mg/dL</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Sodium</div>
            <div class="dataItem">140 mmol/L</div>
            <div class="dataItem">135 - 145 mmol/L</div>
          </div>
        </div>

        <div class="testGroup">
          <div class="groupName">Liver Function Tests</div>
          <div class="groupHeader tableRow data">
            <div class="dataItem">Test Name</div>
            <div class="dataItem">Result</div>
            <div class="dataItem">Reference Range</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Alanine Aminotransferase (ALT)</div>
            <div class="dataItem">25 U/L</div>
            <div class="dataItem">0 - 40 U/L</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Aspartate Aminotransferase (AST)</div>
            <div class="dataItem">30 U/L</div>
            <div class="dataItem">0 - 35 U/L</div>
          </div>
        </div>

        <div class="testGroup">
          <div class="groupName">Lumbar Tests</div>
          <div class="groupHeader tableRow data">
            <div class="dataItem">Test Name</div>
            <div class="dataItem">Result</div>
            <div class="dataItem">Reference Range</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Lumbar Puncture Opening Pressure</div>
            <div class="dataItem" class="groupName">15 cm divO</div>
            <div class="dataItem" class="groupName">10 - 20 cm divO</div>
          </div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
          <div class="data">Test 1</div>
        </div>

        <div class="testGroup">
          <div class="groupName">Toxicology</div>
          <div class="groupHeader tableRow data">
            <div class="dataItem">Test Name</div>
            <div class="dataItem">Result</div>
            <div class="dataItem">Reference Range</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug A</div>
            <div class="dataItem">Negative</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
        </div>

        <div class="testGroup">
          <div class="groupName">Toxicology</div>
          <div class="groupHeader tableRow data">
            <div class="dataItem">Test Name</div>
            <div class="dataItem">Result</div>
            <div class="dataItem">Reference Range</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug A</div>
            <div class="dataItem">Negative</div>
            <div class="dataItem">Negative</div>
          </div>
          <div class="tableRow data">
            <div class="dataItem">Drug B</div>
            <div class="dataItem">Positive</div>
            <div class="dataItem">Negative</div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="footerHeader">Medical Test Report</div>
        <p>
          page: <b class="currentPage">1</b> <b>of</b>
          <b class="totalPages">1</b>
        </p>
      </div>
      <!-- Add more sections for other types of tests -->
    </div>

    <div class="btnContainer">
      <!-- Your test sections here -->

      <button id="cmd" class="btn">Organize</button>
    </div>

    <div class="pagesContainer">
      <div class="pageA4" style="display: none"></div>
    </div>

    <script>
      function splitDataIntoGroups($originalTestGroup, remainingHeight) {
        var $dataElements = $originalTestGroup.find(".data");
        var newDataGroups = [];
        var currentGroupHeight = 0;
        var $currentGroup = $("<div class='testGroup'></div>");

        $dataElements.each(function (index, element) {
          var $dataElement = $(element);
          var dataElementHeight = $dataElement.outerHeight(true);

          if (currentGroupHeight + dataElementHeight <= remainingHeight) {
            $currentGroup.append($dataElement.clone()); // Clone to preserve original structure
            currentGroupHeight += dataElementHeight;
          } else {
            newDataGroups.push($currentGroup);
            $currentGroup = $("<div class='testGroup'></div>");
            $currentGroup.append($dataElement.clone());
            currentGroupHeight = dataElementHeight;
          }
        });

        if ($currentGroup.children().length > 0) {
          newDataGroups.push($currentGroup);
        }

        return newDataGroups;
      }
      //   $(document).ready(function () {});
      $(".btn").click(function () {
        // var doc = new jsPDF();
        // doc.addHTML(document.body, function () {
        //   doc.save("medical_test_report.pdf");
        // });
        var printerMargins = 250;

        var heights = [];
        $(".testGroup").each(function () {
          var height = $(this).outerHeight(true);
          heights.push(height);
        });
        // console.log(heights);

        var headerHeight = $(".header").outerHeight(true);
        var footerHeight = $(".footer").outerHeight(true);
        var patientInfoHeight = $(".patient-info").outerHeight(true);
        var outerSectionsHeight =
          headerHeight + footerHeight + patientInfoHeight;

        var A4W = $(".pageA4").outerWidth(true) - printerMargins;
        var A4H = $(".pageA4").outerHeight(true) - printerMargins;

        var remainingHeight = A4H - outerSectionsHeight;

        // console.log("Header height: ", headerHeight);
        // console.log("Footer height: ", footerHeight);
        // console.log("Patient info height: ", patientInfoHeight);
        // console.log("Header + Footer + Patient: ", outerSectionsHeight);
        // console.log("A4 Height: ", A4H);
        // console.log("Remaining Height: ", remainingHeight);

        // solve the too long tests
        for (let i = heights.length - 1; i >= 0; i--) {
          // Iterate in reverse order
          if (heights[i] >= remainingHeight) {
            // console.log(
            //   "Height at index " + i + " exceeds remaining height:",
            //   heights[i]
            // );

            var $originalTestGroup = $(".testGroup").eq(i);
            var newDataGroups = splitDataIntoGroups(
              $originalTestGroup,
              remainingHeight
            );

            // Replace the original testGroup with the new ones
            $originalTestGroup.replaceWith(newDataGroups);

            // Recalculate remainingHeight after splitting the data
            heights = [];
            $(".testGroup").each(function () {
              var height = $(this).outerHeight(true);
              heights.push(height);
            });
            remainingHeight = A4H - outerSectionsHeight;
          }
        }

        var pagesCount = 1;
        var pageTopTestGroup = [0];
        let sum = 0;
        for (let i = 0; i < heights.length; i++) {
          sum += heights[i];
          if (sum > remainingHeight) {
            if (i == 0) {
              pagesCount = 0;
            }
            console.log("sum: ", sum);
            pageTopTestGroup.push(i);
            console.log(i);
            sum = heights[i];
            pagesCount += 1;
            console.log("pages: ", pagesCount);
          }
        }
        // console.log("top tests: ", pageTopTestGroup);

        $(".pagesContainer").empty();

        for (let i = 0; i < pagesCount; i++) {
          $(".pagesContainer").append($("<div class='pageA4'></div>"));
        }
        const header = $(".header").clone();
        const footer = $(".footer").clone();
        const patientInfo = $(".patient-info").clone();

        // Append header, footer, and patient-info to each .pageA4 element
        $(".pageA4").each(function (index) {
          console.log("Rendering pageA4 index:", index);
          $(this).append(header.clone());
          $(this).append(patientInfo.clone());
          $(this).append($("<div class='testsContainer'></div>"));
          $(this).append(footer.clone());

          // Update footer content with current page number and total pages count
          var currentPageNumber = index + 1;
          $(this).find(".currentPage").text(currentPageNumber);
          $(this).find(".totalPages").text(pagesCount);
        });

        var testGroupsToRender = [];
        var testGroupsLength = $(".testGroup").length;
        // console.log(testGroupsLength);
        var currentTestRange;
        // Append testGroups to corresponding .pageA4
        for (let i = 1; i <= pageTopTestGroup.length; i++) {
          if (i >= pageTopTestGroup.length) {
            // console.log("inside");
            currentTestRange = testGroupsLength + 1 - pageTopTestGroup[i - 1];
          } else {
            currentTestRange = pageTopTestGroup[i] - pageTopTestGroup[i - 1];
          }
          testGroupsToRender.push(currentTestRange);
        }
        // console.log("tests to print", testGroupsToRender);

        // Append test groups to corresponding .pageA4
        var currentPageIndex = 0;
        var currentHeight = 0;
        $(".testGroup").each(function (index) {
          var $testGroup = $(this);
          var testGroupHeight = $testGroup.outerHeight(true);

          // Check if the current test group fits entirely on the current page
          if (
            currentHeight + testGroupHeight > remainingHeight &&
            currentPageIndex <= $(".testGroup").length
          ) {
            if (
              currentPageIndex == 0 &&
              $(".pageA4").eq(currentPageIndex).find(".testGroup").length === 0
            ) {
            } else {
              currentPageIndex++; // Move to the next page
              currentHeight = 0; // Reset current height for the new page
            }
          }

          // Append testGroup to corresponding .pageA4
          $(".pageA4")
            .eq(currentPageIndex)
            .find(".testsContainer")
            .append($testGroup);

          // Update current height
          currentHeight += testGroupHeight;
        });

        $("#content").remove();
        $(".btnContainer").remove();
        // $(".pagesContainer").printElement();
      });
    </script>
  </body>
</html>
